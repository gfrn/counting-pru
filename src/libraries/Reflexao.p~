#define OWN_RAM              		0x000
#define OTHER_RAM           		0x020
#define SHARED_RAM          	 	0x100

#define START				0xFF
#define STOP				0x00
#define DATAOK				0x55

#define SAI1				r30.t15		// P8.11
#define SAI2				r30.t15		// P8.11
#define SAI3				r30.t15		// P8.11
#define SAI4				r30.t15		// P8.11
#define SAI5				r30.t15		// P8.11
#define SAI6				r30.t15		// P8.11


#define ENT1				r31.t14		// P8.16
#define ENT2				r31.t14		// P8.16
#define ENT3				r31.t14		// P8.16
#define ENT4				r31.t14		// P8.16
#define ENT5				r31.t14		// P8.16
#define ENT6				r31.t14		// P8.16

#define COUNT1				r16
#define COUNT2				r17
#define	COUNT3				r18
#define COUNT4				r19
#define	COUNT5				r20
#define COUNT6				r21

#define I				r15
#define J				r14


.setcallreg r29.w0					// PC saving register (CALL instructions)				
.origin 0						// start of program in PRU memory
.entrypoint COMECA					// program entry point (for a debugger)

#include "Reflexao.hp"
#define AM33XX

// Clear Saidas
COMECA:
	CLR	SAI1
	CLR	SAI2
	CLR	SAI3
	CLR	SAI4
	CLR	SAI5
	CLR	SAI6

// Clear Contadores e Registradores
 	ZERO	&COUNT1,4
	ZERO	&COUNT2,4
	ZERO	&COUNT3,4
	ZERO	&COUNT4,4
	ZERO	&COUNT5,4
	ZERO	&COUNT6,4
	ZERO	&I, 4 
	ZERO	&J, 4 

//  Shared Memory Config
	SHRAM_CONFIG
					

// ----- WAIT START --------------------------------------------------------------------
INICIO: 
        LBCO    I, SHRAM_BASE, 0, 1         		// Load Status Status
	QBNE	INICIO, I, START			// Wait until == 0xFF = Start


// ----- COUNT! --------------------------------------------------------------------
// ----- 1 -----
CONTA1:
	QBBC	FIM1, ENT1		// Jump, se nao ha pulso
	ADD	COUNT1, COUNT1, 1	// ||
	SET	SAI1			// || Conta +1 e zera pulso
FIM1:	CLR	SAI1			// ||


// ----- 2 -----
CONTA2:
	QBBC	FIM2, ENT2		// Jump, se nao ha pulso
	ADD	COUNT2, COUNT2, 1	// ||
	SET	SAI2			// || Conta +1 e zera pulso
FIM2:	CLR	SAI2			// ||


// ----- 3 -----
CONTA3:
	QBBC	FIM3, ENT3		// Jump, se nao ha pulso
	ADD	COUNT3, COUNT3, 1	// ||
	SET	SAI3			// || Conta +1 e zera pulso
FIM3:	CLR	SAI3			// ||


// ----- 4 -----
CONTA4:
	QBBC	FIM4, ENT4		// Jump, se nao ha pulso
	ADD	COUNT4, COUNT4, 1	// ||
	SET	SAI4			// || Conta +1 e zera pulso
FIM4:	CLR	SAI4			// ||


// ----- 5 -----
CONTA5:
	QBBC	FIM5, ENT5		// Jump, se nao ha pulso
	ADD	COUNT5, COUNT5, 1	// ||
	SET	SAI5			// || Conta +1 e zera pulso
FIM5:	CLR	SAI5			// ||


// ----- 6 -----
CONTA6:
	QBBC	FIM6, ENT6		// Jump, se nao ha pulso
	ADD	COUNT6, COUNT6, 1	// ||
	SET	SAI6			// || Conta +1 e zera pulso
FIM6:	CLR	SAI6			// ||
	

// ----- VERIFY END --------------------------------------------------------------------
V_END:
	SET	SAI6
	ZERO	&I, 4 
	ZERO	&I, 4 
	ZERO	&I, 4 
	ZERO	&I, 4 
	ZERO	&I, 4 
	ZERO	&I, 4 
	ZERO	&I, 4 
	ZERO	&I, 4 
	ZERO	&I, 4 
	ZERO	&I, 4 
	CLR	SAI5

        LBCO    I, SHRAM_BASE, 0, 1         		// Load Status
	QBNE	CONTA1, I, STOP				// Wait until == 0x00 = Stop



// ----- END! STORE VALUES  --------------------------------------------------------------------
	SBCO	COUNT1, SHRAM_BASE, 1, 1
	SBCO	COUNT2, SHRAM_BASE, 2, 1
	SBCO	COUNT3, SHRAM_BASE, 3, 1
	SBCO	COUNT4, SHRAM_BASE, 4, 1
	SBCO	COUNT5, SHRAM_BASE, 5, 1
	SBCO	COUNT6, SHRAM_BASE, 6, 1


// ----- Data Ready -----
	MOV	I,DATAOK
	SBCO	I, SHRAM_BASE, 0, 1
	

// Clear Contadores e Registradores
 	ZERO	&COUNT1,4
	ZERO	&COUNT2,4
	ZERO	&COUNT3,4
	ZERO	&COUNT4,4
	ZERO	&COUNT5,4
	ZERO	&COUNT6,4
	ZERO	&I, 4 
	ZERO	&J, 4 

	JMP	INICIO

// Never reached	
END:
	HALT
	
	

	
	
